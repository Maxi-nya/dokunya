<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dokunyan Simple Test</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    table { border-collapse: collapse; margin: 0 auto; }
    th, td {
      border: 2px solid #555;
      padding: 10px;
      width: 120px;
      height: 100px;
      text-align: center;
      vertical-align: middle;
    }
    input { width: 100px; text-align: center; }
    .correct { background-color: #b6e3a4; font-weight: bold; }
    .error { background-color: #fbb; }
    .category-cell { background-color: #ddd; font-weight: bold; }
  </style>
</head>
<body>
  <h1 style="text-align:center">Dokunyan Simple Test</h1>
  <div id="message" style="text-align:center; margin-bottom: 10px; font-weight: bold;"></div>
  <div id="game" style="text-align:center"></div>

  <script>
    const rowCat = 'type';
    const colCat = 'element';

    let usedMonsters = new Set();

    function buildGrid(monsters, rowVals, colVals) {
      const gameDiv = document.getElementById("game");
      gameDiv.innerHTML = "";
      usedMonsters = new Set();

      const table = document.createElement("table");

      const header = document.createElement("tr");
      header.appendChild(document.createElement("th")); // top-left empty cell
      colVals.forEach(col => {
        const th = document.createElement("th");
        th.className = "category-cell";
        th.innerText = col;
        header.appendChild(th);
      });
      table.appendChild(header);

      rowVals.forEach(row => {
        const tr = document.createElement("tr");
        const th = document.createElement("th");
        th.className = "category-cell";
        th.innerText = row;
        tr.appendChild(th);

        colVals.forEach(col => {
          const td = document.createElement("td");
          const input = document.createElement("input");

          input.addEventListener("change", () => {
            const name = input.value.trim();
            const monster = monsters.find(m => m.name.toLowerCase() === name.toLowerCase());
            if (!monster) {
              input.className = "error";
              return;
            }
            // Validar que coincida con row y col
            const valRow = monster[rowCat];
            const valCol = monster[colCat];
            const matchRow = Array.isArray(valRow) ? valRow.includes(row) : valRow === row;
            const matchCol = Array.isArray(valCol) ? valCol.includes(col) : valCol === col;

            if (matchRow && matchCol && !usedMonsters.has(monster.name)) {
              usedMonsters.add(monster.name);
              input.className = "correct";
              input.disabled = true;
            } else {
              input.className = "error";
            }
          });

          td.appendChild(input);
          tr.appendChild(td);
        });

        table.appendChild(tr);
      });

      gameDiv.appendChild(table);
    }

    fetch("data/monsters.json")
      .then(res => {
        if (!res.ok) throw new Error("HTTP status " + res.status);
        return res.json();
      })
      .then(monsters => {
        // Filtrar monstruos que tengan data válida para ambas categorías
        const validMonsters = monsters.filter(m => {
          const a = m[rowCat], b = m[colCat];
          const okA = a && (Array.isArray(a) ? a.length > 0 : true);
          const okB = b && (Array.isArray(b) ? b.length > 0 : true);
          return okA && okB;
        });

        if(validMonsters.length === 0) {
          document.getElementById("message").innerText = "❌ No hay monstruos con datos válidos para las categorías seleccionadas.";
          return;
        }

        // Obtener valores únicos para filas y columnas
        function getUniqueVals(key) {
          const vals = new Set();
          validMonsters.forEach(m => {
            const v = m[key];
            if(Array.isArray(v)) v.forEach(x => vals.add(x));
            else if(v) vals.add(v);
          });
          return Array.from(vals);
        }

        const rowVals = getUniqueVals(rowCat).slice(0, 2); // Tomamos solo 2 para test
        const colVals = getUniqueVals(colCat).slice(0, 2);

        if(rowVals.length < 2 || colVals.length < 2) {
          document.getElementById("message").innerText = "❌ No hay suficientes valores únicos para construir la grilla 2x2.";
          return;
        }

        document.getElementById("message").innerText = `Categorías fijas para prueba: ${rowCat} (filas) × ${colCat} (columnas)`;

        buildGrid(validMonsters, rowVals, colVals);
      })
      .catch(err => {
        console.error("Error loading JSON:", err);
        document.getElementById("message").innerText = "❌ Error cargando datos de monstruos.";
      });
  </script>
</body>
</html>
