<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dokunyan (Prototype)</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
    }
    th, td {
      border: 2px solid #555;
      padding: 10px;
      width: 120px;
      height: 100px;
      text-align: center;
      vertical-align: middle;
      position: relative;
    }
    input {
      width: 100px;
      text-align: center;
    }
    .correct {
      background-color: #b6e3a4;
      font-weight: bold;
    }
    .error {
      background-color: #fbb;
    }
    .category-cell {
      background-color: #ddd;
      font-weight: bold;
    }
    .autocomplete-items {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 99;
      background-color: white;
      border: 1px solid #ccc;
      max-height: 120px;
      overflow-y: auto;
    }
    .autocomplete-items div {
      padding: 8px;
      cursor: pointer;
    }
    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center">DOKUNYAN (Prototype)</h1>
  <div id="dailyInfo" style="text-align:center; margin: 10px 0; font-weight: bold;"></div>
  <h3 style="text-align:center">Daily puzzle: combine monster attributes to guess correctly. No repeats!</h3>
  <div id="game" style="text-align:center"></div>

  <script>
    const categories = {
      type: "Monster Type",
      element: "Monster Element",
      weaknesses: "Weakness",
      main_map: "Main Map",
      habitat: "Habitat",
      origin_game: "Origin Game",
      evolves_from: "Evolves From"
    };

    const usedMonsters = new Set();

function getDailySeed(date = new Date()) {
  const year = date.getUTCFullYear();
  const month = String(date.getUTCMonth() + 1).padStart(2, '0');
  const day = String(date.getUTCDate()).padStart(2, '0');
  return `${year}${month}${day}`;
}

    function seededRandom(seed) {
      let h = 2166136261 >>> 0;
      for (let i = 0; i < seed.length; i++) {
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return () => {
        h += h << 13; h ^= h >>> 7;
        h += h << 3; h ^= h >>> 17;
        h += h << 5;
        return (h >>> 0) / 4294967295;
      };
    }

    function uniqueValues(data, key) {
      const values = new Set();
      data.forEach(m => {
        const val = m[key];
        if (Array.isArray(val)) val.forEach(v => values.add(v));
        else if (val) values.add(val);
      });
      return Array.from(values);
    }

    function pickValues(rng, values, count) {
      const shuffled = values.slice().sort(() => rng() - 0.5);
      return shuffled.slice(0, count);
    }

    function autocomplete(input, td, monsterData) {
      input.addEventListener("input", function () {
        let val = this.value;
        closeAllLists();
        if (!val) return false;

        const list = document.createElement("div");
        list.setAttribute("class", "autocomplete-items");
        td.appendChild(list);

        monsterData.forEach(monster => {
          if (monster.name.toLowerCase().startsWith(val.toLowerCase())) {
            const item = document.createElement("div");
            item.innerText = monster.name;
            item.addEventListener("click", function () {
              input.value = monster.name;
              closeAllLists();
              input.dispatchEvent(new Event("change"));
            });
            list.appendChild(item);
          }
        });
      });

      function closeAllLists() {
        const lists = document.querySelectorAll(".autocomplete-items");
        lists.forEach(l => l.remove());
      }

      document.addEventListener("click", function (e) {
        if (e.target !== input) closeAllLists();
      });
    }

    function buildGrid(monsters, rowCat, colCat, rowVals, colVals) {
      const gameDiv = document.getElementById("game");
      const table = document.createElement("table");

      const header = document.createElement("tr");
      header.appendChild(document.createElement("th"));
      colVals.forEach(col => {
        const th = document.createElement("th");
        th.className = "category-cell";
        th.innerText = col;
        header.appendChild(th);
      });
      table.appendChild(header);

      rowVals.forEach(row => {
        const tr = document.createElement("tr");
        const th = document.createElement("th");
        th.className = "category-cell";
        th.innerText = row;
        tr.appendChild(th);

        colVals.forEach(col => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          autocomplete(input, td, monsters);

          input.addEventListener("change", () => {
            const name = input.value.trim();
            const monster = monsters.find(m => m.name.toLowerCase() === name.toLowerCase());

            if (!monster) {
              input.className = "error";
              return;
            }

            const valRow = monster[rowCat];
            const valCol = monster[colCat];

            const matchRow = Array.isArray(valRow) ? valRow.includes(row) : valRow === row;
            const matchCol = Array.isArray(valCol) ? valCol.includes(col) : valCol === col;

            if (matchRow && matchCol && !usedMonsters.has(monster.name)) {
              usedMonsters.add(monster.name);
              input.className = "correct";
              input.disabled = true;
            } else {
              input.className = "error";
            }
          });

          td.appendChild(input);
          tr.appendChild(td);
        });

        table.appendChild(tr);
      });

      gameDiv.appendChild(table);
    }
    
fetch("monsters.json")
  .then(res => res.json())
  .then(monsters => {
    const seed = getDailySeed();
    const rng = seededRandom(seed);
    const categoryKeys = Object.keys(categories).sort(() => rng() - 0.5);
    const rowCat = categoryKeys[0];
    const colCat = categoryKeys[1];

    // 1ï¸âƒ£ Filtrar monstruos que tengan datos vÃ¡lidos en ambas categorÃ­as
    const validMonsters = monsters.filter(m => {
      const a = m[rowCat], b = m[colCat];
      const okA = a && (Array.isArray(a) ? a.length > 0 : true);
      const okB = b && (Array.isArray(b) ? b.length > 0 : true);
      return okA && okB;
    });

    // 2ï¸âƒ£ Crear mapa de combinaciones vÃ¡lidas: "row|col" => [monsters]
    const comboMap = new Map();
    validMonsters.forEach(m => {
      const rows = Array.isArray(m[rowCat]) ? m[rowCat] : [m[rowCat]];
      const cols = Array.isArray(m[colCat]) ? m[colCat] : [m[colCat]];
      rows.forEach(r => {
        cols.forEach(c => {
          const key = `${r}|${c}`;
          if (!comboMap.has(key)) comboMap.set(key, []);
          comboMap.get(key).push(m.name);
        });
      });
    });

    // 3ï¸âƒ£ Obtener todas las filas y columnas posibles
    const allRows = [...new Set(Array.from(comboMap.keys(), k => k.split('|')[0]))];
    const allCols = [...new Set(Array.from(comboMap.keys(), k => k.split('|')[1]))];

    // 4ï¸âƒ£ Buscar combinaciÃ³n 3x3 con soluciÃ³n en todas las celdas
    function findValidGrid(rng, rows, cols, comboMap) {
      const shuffledRows = rows.slice().sort(() => rng() - 0.5);
      const shuffledCols = cols.slice().sort(() => rng() - 0.5);

      for (let i = 0; i <= shuffledRows.length - 3; i++) {
        for (let j = 0; j <= shuffledCols.length - 3; j++) {
          const rowSlice = shuffledRows.slice(i, i + 3);
          const colSlice = shuffledCols.slice(j, j + 3);

          const allValid = rowSlice.every(r =>
            colSlice.every(c => comboMap.has(`${r}|${c}`))
          );

          if (allValid) return { rows: rowSlice, cols: colSlice };
        }
      }
      return null;
    }

    const result = findValidGrid(rng, allRows, allCols, comboMap);

    if (!result) {
      document.getElementById("game").innerText = "âŒ No se pudo generar una grilla vÃ¡lida con los datos actuales.";
      return;
    }

    const { rows: rowVals, cols: colVals } = result;

    // ðŸ—“ï¸ Mostrar informaciÃ³n del dÃ­a
    const dailyInfo = document.getElementById("dailyInfo");
    dailyInfo.innerText = `ðŸ—“ï¸ Puzzle del dÃ­a: ${seed.slice(0,4)}-${seed.slice(4,6)}-${seed.slice(6)} â€“ CategorÃ­as: ${categories[rowCat]} Ã— ${categories[colCat]}`;

    // ðŸ§© Construir la grilla
    buildGrid(validMonsters, rowCat, colCat, rowVals, colVals);
  })
  .catch(err => console.error("Failed to load JSON", err));
  </script>
</body>
</html>
